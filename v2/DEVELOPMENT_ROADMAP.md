# TotoTrip V2 - 开发优先级路线图

## 📊 当前项目状态评估

### ✅ 已完成 (Foundation)
- 前端UI框架 (Next.js 15 + Tailwind + shadcn/ui)
- AI聊天功能 (Claude API集成 + 流式响应)
- 地图可视化 (Leaflet + OpenStreetMap)
- 位置推荐展示
- 数据库设计 (10张表，完整Schema)
- 用户认证系统 (注册/登录/登出)
- RLS安全策略
- 自动Profile创建

### ❌ 关键缺失 (Critical Gaps)
- **聊天不持久化** - 刷新页面后对话消失
- **无历史记录** - 用户无法查看过往对话
- **无数据保存** - AI推荐的位置无法保存
- **无Trip管理** - 无法创建和管理行程
- **使用模拟数据** - 没有真实的POI数据

---

## 🎯 产品核心价值分析

### 用户关键旅程：
```
发现问题 → AI咨询 → 获得推荐 → 保存计划 → 执行行程 → 回顾总结
   ↑           ↑          ↑          ↑         ↑         ↑
 现有功能   现有功能   ❌缺失    ❌缺失    ❌缺失    ❌缺失
```

### 当前最大痛点：
**用户无法"拥有"他们的数据** - 所有对话和推荐在刷新后消失，用户无法回来继续使用。

---

## 🚀 开发优先级 (P0 → P3)

## 【P0 - 紧急】数据持久化 - 让产品真正可用

**目标：** 用户的对话和数据能够保存和恢复

### 1. 聊天消息持久化 ⭐⭐⭐⭐⭐
**为什么优先：**
- 这是产品可用性的基础
- 用户期望对话被保存（所有聊天应用的标准功能）
- 没有这个功能，用户无法"回来"
- 影响用户留存率

**实现内容：**
- 保存用户消息到 `chat_messages` 表
- 保存AI回复到 `chat_messages` 表
- 保存location数据到 `locations` 字段（JSONB）
- 页面加载时恢复聊天历史
- 显示加载状态

**技术要点：**
```typescript
// 每次发送消息时
await supabase.from('chat_messages').insert({
  session_id: currentSessionId,
  role: 'user',
  content: userMessage
});

// AI回复时
await supabase.from('chat_messages').insert({
  session_id: currentSessionId,
  role: 'assistant',
  content: aiResponse,
  locations: parsedLocations // JSONB
});
```

**工作量：** 1-2天
**风险：** 低

---

### 2. 聊天会话管理 ⭐⭐⭐⭐
**为什么优先：**
- 用户需要在多个主题间切换（北京旅行 vs 上海旅行）
- 组织对话的基础功能
- 为后续功能打基础

**实现内容：**
- 创建新会话 (chat_sessions表)
- 会话列表侧边栏（显示标题、时间）
- 切换会话
- 自动生成会话标题（基于第一条消息）
- 删除/归档会话

**UI布局：**
```
┌─────────────┬──────────────────────┐
│  会话列表    │   当前聊天内容        │
│  (侧边栏)    │                      │
│ • 北京3日游  │   消息1              │
│ • 上海美食   │   消息2              │
│ + 新对话     │   [输入框]           │
└─────────────┴──────────────────────┘
```

**工作量：** 1-2天
**风险：** 低

---

## 【P1 - 高优先级】核心功能 - MVP必需

### 3. 保存推荐位置 ⭐⭐⭐⭐
**为什么优先：**
- 用户希望"收藏"AI推荐的地点
- 是从"浏览"到"计划"的关键转换
- 后续功能（行程规划）的基础数据

**实现内容：**
- AI推荐的位置旁显示"保存"按钮
- 保存到 `saved_locations` 表
- 关联到当前trip或独立保存
- 我的收藏页面
- 按类别筛选（餐厅/景点/酒店）

**UI组件：**
```typescript
<LocationCard location={loc}>
  <Button onClick={() => saveLocation(loc)}>
    {isSaved ? '已保存 ✓' : '保存'}
  </Button>
</LocationCard>
```

**工作量：** 1天
**风险：** 低

---

### 4. Trip创建与管理 ⭐⭐⭐⭐
**为什么优先：**
- 组织多个地点的容器
- 区分不同旅行的核心功能
- 用户心智模型："我要去北京旅行"

**实现内容：**
- 创建Trip（标题、目的地、日期、预算）
- Trip列表页面（显示所有trips）
- Trip详情页面（显示该trip的所有保存位置）
- 将聊天会话关联到Trip
- 将保存的位置关联到Trip

**数据流：**
```
创建Trip → 开始聊天 → AI推荐 → 保存位置 → 关联到Trip
```

**工作量：** 2-3天
**风险：** 低-中

---

### 5. 用户Dashboard ⭐⭐⭐
**为什么优先：**
- 用户需要看到"我的内容"
- 提供清晰的导航结构
- 增强产品的"拥有感"

**实现内容：**
- Dashboard首页（显示最近trips、聊天）
- 导航栏（Dashboard / Trips / Saved / Profile）
- 快速操作（新建trip、开始聊天）

**页面结构：**
```
/dashboard        - 总览
/dashboard/trips  - 我的行程
/dashboard/saved  - 我的收藏
/dashboard/chats  - 聊天历史
/profile          - 个人设置
```

**工作量：** 2天
**风险：** 低

---

## 【P2 - 中优先级】增强体验 - Post-MVP

### 6. 行程日历与Timeline ⭐⭐⭐
**为什么延后：** 需要先有基础数据（trips + locations）

**实现内容：**
- 日历视图显示trip时间线
- 每日行程规划
- 拖拽排序活动
- 时间规划建议

**工作量：** 3-4天
**风险：** 中

---

### 7. 预算跟踪 ⭐⭐
**为什么延后：** 不是初期核心价值

**实现内容：**
- 记录花费（expenses表）
- 分类统计
- 预算vs实际对比
- 货币转换

**工作量：** 2天
**风险：** 低

---

### 8. 真实POI数据集成 ⭐⭐⭐
**为什么延后：** MVP可以先用AI生成的数据

**实现内容：**
- 集成高德地图API
- 获取真实POI数据（评分、照片、营业时间）
- 位置搜索功能
- 地图标记点击查看详情

**技术方案：**
```typescript
// API Route: /api/places/search
async function searchPlaces(query: string, city: string) {
  const response = await fetch(
    `https://restapi.amap.com/v3/place/text?keywords=${query}&city=${city}&key=${AMAP_KEY}`
  );
  return response.json();
}
```

**工作量：** 2-3天
**风险：** 中（需要API key和配额）

---

### 9. 社交分享功能 ⭐⭐
**为什么延后：** 需要有足够的内容可分享

**实现内容：**
- 分享trip（trip_shares表）
- 生成分享链接
- 权限控制（只读/编辑）
- 公开trip页面

**工作量：** 2天
**风险：** 低

---

## 【P3 - 低优先级】未来迭代

### 10. 预订与联盟营销 ⭐
**为什么最后：** 需要流量和用户基础

**实现内容：**
- 集成Booking.com / Klook API
- 显示预订链接
- 跟踪佣金（bookings表）

**工作量：** 3-4天
**风险：** 高（商务谈判、技术集成）

---

### 11. 多语言支持 ⭐
**实现内容：**
- i18n框架
- 英文/中文切换
- AI回复多语言

**工作量：** 2-3天
**风险：** 低

---

### 12. 离线功能 / PWA ⭐
**实现内容：**
- Service Worker
- 离线缓存
- 安装到手机

**工作量：** 2-3天
**风险：** 中

---

## 📅 建议开发Sprint计划

### Sprint 1 (本周) - 数据持久化 🔥
**目标：** 让产品真正可用
- Day 1-2: 聊天消息持久化
- Day 3-4: 聊天会话管理
- Day 5: 测试 + Bug修复

**交付成果：**
- ✅ 用户刷新页面后对话保留
- ✅ 用户可以创建多个聊天会话
- ✅ 侧边栏显示会话列表

---

### Sprint 2 (下周) - 位置保存 🔥
**目标：** 用户可以收藏和管理地点
- Day 1: 保存位置功能
- Day 2: 我的收藏页面
- Day 3: Trip创建功能
- Day 4: Trip列表和详情
- Day 5: 测试 + 整合

**交付成果：**
- ✅ 用户可以保存AI推荐的地点
- ✅ 用户可以创建和管理trips
- ✅ 地点可以关联到trips

---

### Sprint 3 (第三周) - Dashboard & Navigation
**目标：** 完整的导航和用户体验
- Day 1-2: Dashboard设计和实现
- Day 3: 导航栏优化
- Day 4-5: UI/UX打磨

**交付成果：**
- ✅ 完整的用户Dashboard
- ✅ 清晰的导航结构
- ✅ MVP功能完整可用

---

### Sprint 4+ (后续) - 增强功能
根据用户反馈决定：
- 行程Timeline
- 预算跟踪
- 真实数据集成
- 或其他P2/P3功能

---

## 🎯 关键成功指标 (KPIs)

### Sprint 1 成功标准：
- [ ] 100%的聊天消息被保存到数据库
- [ ] 页面刷新后对话恢复时间 < 1秒
- [ ] 用户可以创建至少3个会话并切换

### Sprint 2 成功标准：
- [ ] 用户可以保存至少5个位置
- [ ] 用户可以创建trip并关联位置
- [ ] 我的收藏页面加载时间 < 500ms

### Sprint 3 成功标准：
- [ ] Dashboard显示所有用户数据
- [ ] 导航清晰，用户可以快速找到任何功能
- [ ] 整体产品可用性达到MVP标准

---

## 🚨 技术债务 & 风险

### 当前技术债务：
1. **聊天组件复杂度** - MessageList.tsx较大，需要重构
2. **类型定义不完整** - 部分组件缺少TypeScript类型
3. **错误处理** - 网络错误处理不够友好
4. **测试覆盖** - 没有单元测试

### 风险缓解：
- **数据库性能** - 当前规模无问题，后续考虑索引优化
- **API配额** - Claude API使用Haiku模型，成本可控
- **扩展性** - Schema设计良好，易于扩展

---

## 💡 产品策略建议

### 1. 先做"可用"，再做"好用"
优先级P0和P1是让产品真正可用的基础，P2/P3是锦上添花。

### 2. 数据是护城河
用户在产品中创造的数据（对话、收藏、行程）是留存的关键。

### 3. 快速迭代，收集反馈
完成Sprint 1-3后，应该尽快找真实用户测试，根据反馈调整。

### 4. 差异化竞争
vs Mindtrip：
- ✅ 专注中国旅行（本地化优势）
- ✅ 实时AI助手（24/7对话）
- ✅ 更好的中文支持
- 🔜 集成中国本地服务（高德、美团）

---

## 📊 资源评估

### 当前技术栈成熟度：
- ✅ Next.js - 熟练
- ✅ React - 熟练
- ✅ Supabase - 基础已打好
- ✅ Claude API - 已集成
- 🔜 高德地图 - 待学习

### 预计总工作量（MVP）：
- Sprint 1: 5天
- Sprint 2: 5天
- Sprint 3: 5天
- **总计：15个工作日（3周）**

### 成本估算（月度）：
- Supabase: $25/月（Pro计划）
- Claude API: $50-100/月（预估）
- 域名+托管: $10/月
- **总计：$85-135/月**

---

## 🎉 总结

**立即开始：Sprint 1 - 聊天消息持久化**

这是最critical的功能，直接影响产品可用性。完成后，用户才能真正"使用"这个产品，而不只是"试用"。

**下一步行动：**
1. ✅ 创建 `chat_sessions` 的CRUD API
2. ✅ 创建 `chat_messages` 的保存逻辑
3. ✅ 实现历史记录加载
4. ✅ 添加会话列表UI

你准备好开始Sprint 1了吗？
